REQUIRES: x86
RUN: split-file %s %t.dir && cd %t.dir

RUN: llvm-mc -filetype=obj -triple=arm64ec-windows unmangled-dll-main.s -o unmangled-dll-main.obj
RUN: llvm-mc -filetype=obj -triple=arm64ec-windows mangled-dll-main.s -o mangled-dll-main.obj
RUN: llvm-mc -filetype=obj -triple=arm64ec-windows unmangled-func.s -o unmangled-func.obj
RUN: llvm-mc -filetype=obj -triple=arm64ec-windows mangled-func.s -o mangled-func.obj
RUN: llvm-mc -filetype=obj -triple=x86_64-windows unmangled-dll-main.s -o x64-dll-main.obj
RUN: llvm-mc -filetype=obj -triple=arm64ec-windows %S/Inputs/loadconfig-arm64ec.s -o loadconfig-arm64ec.obj

RUN: lld-link -machine:arm64ec -dll -out:test.dll unmangled-dll-main.obj loadconfig-arm64ec.obj

RUN: llvm-objdump -d test.dll | FileCheck -check-prefix=DISASM %s
DISASM:      0000000180001000 <.text>:
DISASM-NEXT: 180001000: d65f03c0     ret
DISASM-EMPTY:
DISASM-NEXT: Disassembly of section .hexpthk:
DISASM-EMPTY:
DISASM:      180002000: 48 8b c4                     movq    %rsp, %rax
DISASM-NEXT: 180002003: 48 89 58 20                  movq    %rbx, 0x20(%rax)
DISASM-NEXT: 180002007: 55                           pushq   %rbp
DISASM-NEXT: 180002008: 5d                           popq    %rbp
DISASM-NEXT: 180002009: e9 f2 ef ff ff               jmp     0x180001000 <.text>
DISASM-NEXT: 18000200e: cc                           int3
DISASM-NEXT: 18000200f: cc                           int3

RUN: lld-link -machine:arm64ec -dll -out:test.dll mangled-dll-main.obj loadconfig-arm64ec.obj
RUN: llvm-objdump -d test.dll | FileCheck -check-prefix=DISASM %s

RUN: lld-link -machine:arm64ec -dll -out:test.dll unmangled-func.obj loadconfig-arm64ec.obj -entry:func
RUN: llvm-objdump -d test.dll | FileCheck -check-prefix=DISASM %s

RUN: lld-link -machine:arm64ec -dll -out:test.dll mangled-func.obj loadconfig-arm64ec.obj -entry:func
RUN: llvm-objdump -d test.dll | FileCheck -check-prefix=DISASM %s

RUN: lld-link -machine:arm64ec -dll -out:test.dll mangled-func.obj loadconfig-arm64ec.obj "-entry:#func"
RUN: llvm-objdump -d test.dll | FileCheck -check-prefix=DISASM %s

RUN: lld-link -machine:arm64ec -dll -out:test.dll unmangled-func.obj loadconfig-arm64ec.obj -noentry -export:func
RUN: llvm-objdump -d test.dll | FileCheck -check-prefix=DISASM %s

RUN: lld-link -machine:arm64ec -dll -out:test.dll mangled-func.obj loadconfig-arm64ec.obj -noentry -export:func
RUN: llvm-objdump -d test.dll | FileCheck -check-prefix=DISASM %s

RUN: lld-link -machine:arm64ec -dll -out:test.dll mangled-func.obj loadconfig-arm64ec.obj -noentry "-export:#func"
RUN: llvm-objdump -d test.dll | FileCheck -check-prefix=DISASM %s

DISASM2:      0000000180001000 <.text>:
DISASM2-NEXT: 180001000: d65f03c0     ret

RUN: lld-link -machine:arm64ec -dll -out:test.dll mangled-func.obj loadconfig-arm64ec.obj -noentry "-include:#func"
RUN: llvm-objdump -d test.dll | FileCheck -check-prefix=DISASM2 %s

RUN: not lld-link -machine:arm64ec -dll -out:test.dll unmangled-func.obj loadconfig-arm64ec.obj "-entry:#func" 2>&1 | FileCheck -check-prefix=FUNC-NOT-FOUND %s
RUN: not lld-link -machine:arm64ec -dll -out:test.dll unmangled-func.obj loadconfig-arm64ec.obj -noentry "-export:#func" 2>&1 | FileCheck -check-prefix=FUNC-NOT-FOUND %s
FUNC-NOT-FOUND: undefined symbol: #func

RUN: not lld-link -machine:arm64ec -dll -out:test.dll mangled-func.obj loadconfig-arm64ec.obj -noentry -include:func 2>&1 | FileCheck -check-prefix=FUNC-NOT-FOUND2 %s
FUNC-NOT-FOUND2: undefined symbol: func

RUN: lld-link -machine:arm64ec -dll -out:test.dll x64-dll-main.obj loadconfig-arm64ec.obj
RUN: llvm-objdump -d test.dll | FileCheck -check-prefix=DISASM-X64 %s
DISASM-X64:      0000000180001000 <.text>:
DISASM-X64-NEXT: 180001000: c3                           retq

#--- unmangled-dll-main.s
    .text
    .globl _DllMainCRTStartup
_DllMainCRTStartup:
    ret

#--- mangled-dll-main.s
    .text
    .globl "#_DllMainCRTStartup"
"#_DllMainCRTStartup":
    ret

#--- unmangled-func.s
    .text
    .globl func
func:
    ret

#--- mangled-func.s
    .text
    .globl "#func"
"#func":
    ret
